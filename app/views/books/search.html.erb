<!-- app/views/books/search.html.erb -->

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">

      <h1 class="h4 mb-4 text-center">Step 1: ISBNで書籍を検索する</h1>

      <% if flash[:alert].present? %>
        <div class="alert alert-danger">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <p class="text-muted small mb-3">
            ISBN（10桁 or 13桁）を入力してください。
          </p>

          <%= form_with url: search_books_path, method: :get, local: true do %>
            <div class="mb-3">
              <%= label_tag :q, "ISBN（10桁 / 13桁）", class: "form-label" %>
              <%= text_field_tag :q, @query, class: "form-control", placeholder: "例: 4101010031 / 9784101010038 " %>
            </div>

            <div class="d-grid mb-3">
              <%= submit_tag "検索", class: "btn btn-primary" %>
            </div>
          <% end %>

          <div class="text-center">
            <%= link_to "手動で登録する", new_book_path(isbn: @query), class: "btn btn-outline-secondary btn-sm" %>
          </div>
        </div>
      </div>

      <!-- 検索結果 -->
<!-- 検索結果 -->
<% if @results.present? %>
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h6 mb-3">検索結果</h2>

      <% @results.each do |result| %>
        <% summary = result[:data]["summary"] %>
        <% isbn13 = summary["isbn"] %>

        <div class="border rounded p-3 mb-3">
          <p class="mb-1">
            <strong><%= summary["title"] %></strong>
          </p>
          <p class="mb-1">
            著者: <%= summary["author"] %><br>
            出版社: <%= summary["publisher"] %><br>
            ISBN: <%= isbn13 %>
          </p>

          <% if result[:cover_url].present? %>
            <div class="mb-2">
              <img src="<%= result[:cover_url] %>" class="img-fluid" style="max-height: 150px;">
            </div>
          <% end %>

          <%= button_to "この本を選ぶ",
                create_by_isbn_books_path(isbn: isbn13),
                method: :post,
                class: "btn btn-success btn-sm" %>
        </div>
      <% end %>

    </div>
  </div>
<% end %>
