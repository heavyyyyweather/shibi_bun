<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">

      <h1 class="mb-4">Step 1: ISBNで書籍を検索する</h1>
      <p class="text-muted">
        ISBNコード（10桁 / 13桁）を入力して検索してください。ヒットしない場合は「手動で登録する」から書誌情報を入力できます。
      </p>

      <% if flash[:alert].present? %>
        <div class="alert alert-danger">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <div class="card mb-4">
        <div class="card-body">

          <%= form_with url: search_books_path,
                        method: :get,
                        local: true do |f| %>

            <div class="mb-3">
              <%= f.label :q, "ISBN（10桁 / 13桁）", class: "form-label" %>
              <%= f.text_field :q,
                               value: @query,
                               class: "form-control",
                               placeholder: "例: 4101010031 / 9784101010038" %>
            </div>

            <div class="d-flex gap-3">
              <%= f.submit "検索", class: "btn btn-primary" %>

              <%= link_to "手動で登録する",
                          new_book_path(isbn: @query),
                          class: "btn btn-outline-secondary" %>
            </div>
          <% end %>
        </div>
      </div>

      <% if @query.present? %>
        <h2 class="h5 mb-3">検索結果</h2>

        <% if @results.any? %>
          <div class="row">
            <% @results.each do |res| %>
              <% summary   = res[:data]["summary"] %>
              <% title     = summary["title"] %>
              <% author    = summary["author"] %>
              <% publisher = summary["publisher"] %>
              <% pubdate   = summary["pubdate"] %>
              <% isbn13    = summary["isbn"] %>
              <% cover_url = res[:cover_url] %>

              <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                  <% if cover_url.present? %>
                    <img src="<%= cover_url %>"
                         class="card-img-top"
                         alt="<%= title %>">
                  <% end %>
                  <div class="card-body">
                    <h5 class="card-title"><%= title %></h5>
                    <p class="card-text small mb-2">
                      <%= author %><br>
                      <%= publisher %><br>
                      <%= pubdate %>
                    </p>
                    <%= button_to "この本を選ぶ",
                      create_by_isbn_books_path(isbn: isbn13),
                      method: :post,
                      class: "btn btn-sm btn-success" %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">
            「<%= @query %>」に一致する書誌情報は見つかりませんでした。
          </p>
        <% end %>
      <% end %>

    </div>
  </div>
</div>
