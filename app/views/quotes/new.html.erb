<div class="container my-4">
  <h1 class="mb-4">一文を投稿する</h1>

  <!-- ステップ案内 -->
  <nav class="mb-4 small text-muted">
    <strong>Step 1.</strong> 本をえらぶ →
    <strong>Step 2.</strong> 一文を書く
  </nav>

  <!-- Step 1: 書籍検索フォーム -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h6">Step 1: 本をえらぶ</h2>
      <p class="small text-muted">本のタイトル・著者名・ISBNのいずれかで検索できます。</p>

      <%= form_with url: new_quote_path, method: :get, local: true do |f| %>
        <div class="mb-2">
          <%= f.label :book_search, "書籍を検索", class: "form-label" %>
          <%= f.text_field :book_search, value: @book_search, class: "form-control", placeholder: "タイトル / 著者 / ISBN" %>
        </div>
        <%= f.submit "検索", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <!-- Step 2: 投稿フォーム -->
  <div class="card">
    <div class="card-body">
      <h2 class="h6">Step 2: 一文を書く</h2>

      <%= form_with model: @quote, url: quotes_path, local: true, data: { turbo: false } do |f| %>
        <%= hidden_field_tag :book_search, @book_search %>

        <!-- エラー表示 -->
        <% if @quote.errors.any? %>
          <div class="alert alert-danger">
            <ul class="mb-0">
              <% @quote.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- 書籍候補 -->
        <div class="mb-3">
          <strong>書籍を選択してください</strong>
          <% if @book_candidates.present? %>
            <% @book_candidates.each do |book| %>
              <div class="form-check">
                <%= f.radio_button :book_id, book.id, class: "form-check-input", checked: (@quote.book_id == book.id) %>
                <%= f.label :book_id, "#{book.title}（#{book.publisher}）", class: "form-check-label" %>
              </div>
            <% end %>
          <% elsif @google_volumes.present? %>
            <% @google_volumes.each do |volume| %>
              <% info = volume["volumeInfo"] || {} %>
              <% isbn_13 = info.dig("industryIdentifiers")&.find { |id| id["type"] == "ISBN_13" }&.dig("identifier") %>
              <% next if isbn_13.blank? %>
              <div class="form-check">
                <%= radio_button_tag :google_isbn, isbn_13, params[:google_isbn] == isbn_13, class: "form-check-input" %>
                <%= label_tag :google_isbn, "#{info["title"]} ― #{info["authors"]&.join(", ")}", class: "form-check-label" %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted small mt-2">
              「<%= @book_search %>」に一致する書籍は見つかりませんでした。
              <%= link_to "手動で登録する", new_book_path(title: @book_search) %>
            </p>
          <% end %>
        </div>

        <!-- 引用本文 -->
        <div class="mb-3">
          <%= f.label :body, "引用本文（200字以内）", class: "form-label" %>
          <%= f.text_area :body, rows: 5, class: "form-control" %>
        </div>

        <!-- ページ番号 -->
        <div class="mb-3">
          <%= f.label :page, "ページ番号（任意）", class: "form-label" %>
          <%= f.number_field :page, class: "form-control", style: "width: 120px;" %>
        </div>

        <!-- 投稿ボタン -->
        <%= f.submit "投稿する", class: "btn btn-success" %>
      <% end %>
    </div>
  </div>
</div>
